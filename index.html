<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fantasy Runner Final</title>
<style>
body{margin:0;overflow:hidden;background:#bdeaff;}
canvas{display:block;margin:0 auto;background:#87ceeb;}

.controls{
 position:fixed;
 bottom:15px;
 left:50%;
 transform:translateX(-50%);
 display:flex;
 gap:30px;
}

button{
 width:70px;
 height:70px;
 font-size:24px;
 border-radius:50%;
}

#rotateMessage{
 position:fixed;
 top:0;
 left:0;
 width:100%;
 height:100%;
 background:black;
 color:white;
 display:none;
 justify-content:center;
 align-items:center;
 text-align:center;
 font-size:24px;
 z-index:999;
}
</style>
</head>
<body>

<div id="rotateMessage">ğŸ“± ê°€ë¡œë¡œ ëŒë ¤ì£¼ì„¸ìš”</div>

<canvas id="game"></canvas>

<div class="controls">
<button id="left">â¬…ï¸</button>
<button id="jumpBtn">â¬†ï¸</button>
<button id="right">â¡ï¸</button>
</div>

<script>
/* ---------- ê³ ì • í•´ìƒë„ ---------- */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let baseWidth=1000;
let baseHeight=600;
canvas.width=baseWidth;
canvas.height=baseHeight;
canvas.style.width="100vw";
canvas.style.height="100vh";

/* ---------- ë°©í–¥ ì²´í¬ ---------- */
function checkOrientation(){
 if(window.innerHeight>window.innerWidth){
  rotateMessage.style.display="flex";
 }else{
  rotateMessage.style.display="none";
 }
}
window.addEventListener("resize",checkOrientation);
checkOrientation();

/* ---------- ë³€ìˆ˜ ---------- */
let gravity=0.45;
let stage=1;
let score=0;
let totalScore=0;
let spacing=500;
let gameSpeed=3;
let stageObstacleCount=0;
let maxStage=10;

let health=3;
let invincible=false;
let invincibleTimer=0;

let boss=null;
let bossMode=false;
let fireballs=[];

let gameActive=true;
let gameOver=false;
let ending=false;

let keys={left:false,right:false};

let player={
 x:200,
 y:baseHeight-150,
 width:60,
 height:60,
 velocityY:0,
 speed:6,
 jumpCount:0
};

let obstacles=[];
let items=[];

/* ---------- ì´ˆê¸°í™” ---------- */
function initGame(){
 stage=1;
 totalScore=0;
 health=3;
 gameOver=false;
 ending=false;
 gameActive=true;
 startStage();
}

function startStage(){
 score=0;
 stageObstacleCount=0;
 obstacles=[];
 items=[];
 bossMode=false;
 boss=null;
 fireballs=[];

 gameSpeed=2+stage;
 spacing=520-stage*25;
 if(spacing<260) spacing=260;

 if(stage===5||stage===10){
  bossMode=true;
  boss={
   x:baseWidth+300,
   y:baseHeight-250,
   width:200,
   height:200,
   health:5,
   velocityY:0,
   jumpCooldown:120,
   dashCooldown:200,
   dashing:false
  };
 }

 player.y=baseHeight-150;
 player.velocityY=0;
 player.jumpCount=0;
}

initGame();

/* ---------- ì…ë ¥ ---------- */
function jump(){
 if(gameOver){initGame();return;}
 if(!gameActive)return;

 if(player.jumpCount<3){
  if(player.jumpCount===0) player.velocityY=-18;
  else if(player.jumpCount===1) player.velocityY=-17;
  else player.velocityY=-15;
  player.jumpCount++;
 }
}

document.addEventListener("keydown",e=>{
 if(e.key==="ArrowLeft")keys.left=true;
 if(e.key==="ArrowRight")keys.right=true;
 if(e.key===" "||e.key==="ArrowUp")jump();
});
document.addEventListener("keyup",e=>{
 if(e.key==="ArrowLeft")keys.left=false;
 if(e.key==="ArrowRight")keys.right=false;
});

left.ontouchstart=()=>keys.left=true;
left.ontouchend=()=>keys.left=false;
right.ontouchstart=()=>keys.right=true;
right.ontouchend=()=>keys.right=false;
jumpBtn.ontouchstart=jump;

/* ---------- ìƒì„± ---------- */
function spawnObstacle(){
 if(bossMode)return;
 if(stageObstacleCount>=10)return;

 let type=stageObstacleCount<5?"flower":"monster";
 let height=type==="flower"?80:200;
 let lastX=obstacles.length>0?obstacles[obstacles.length-1].x:baseWidth;

 obstacles.push({
  x:lastX+spacing,
  y:baseHeight-50-height,
  width:80,
  height:height,
  type:type,
  passed:false,
  hit:false
 });

 stageObstacleCount++;
}

function spawnItem(){
 if(Math.random()<0.02){
  let type=Math.random()<0.5?"heart":"shield";
  items.push({
   x:baseWidth+100,
   y:Math.random()*(baseHeight-200),
   width:40,
   height:40,
   type:type
  });
 }
}

/* ---------- ì—…ë°ì´íŠ¸ ---------- */
function update(){
 if(!gameActive)return;

 if(keys.left)player.x-=player.speed;
 if(keys.right)player.x+=player.speed;

 if(player.x<0)player.x=0;
 if(player.x+player.width>baseWidth)
  player.x=baseWidth-player.width;

 player.velocityY+=gravity;
 player.y+=player.velocityY;

 if(player.y+player.height>=baseHeight-50){
  player.y=baseHeight-50-player.height;
  player.jumpCount=0;
 }

 if(invincible){
  invincibleTimer--;
  if(invincibleTimer<=0)invincible=false;
 }

 if(obstacles.length===0||
   obstacles[obstacles.length-1].x<baseWidth-spacing){
  spawnObstacle();
 }

 spawnItem();

 obstacles.forEach(obj=>{
  obj.x-=gameSpeed;

  if(player.x<obj.x+obj.width &&
     player.x+player.width>obj.x &&
     player.y<obj.y+obj.height &&
     player.y+player.height>obj.y){
   if(!obj.hit&&!invincible){
    obj.hit=true;
    health--;
    if(health<=0){gameActive=false;gameOver=true;}
   }
  }

  if(!obj.passed&&obj.x+obj.width<player.x){
   obj.passed=true;
   score++;
   totalScore++;
  }
 });

 items.forEach(item=>{
  item.x-=gameSpeed;

  if(player.x<item.x+item.width &&
     player.x+player.width>item.x &&
     player.y<item.y+item.height &&
     player.y+player.height>item.y){
   if(item.type==="heart"&&health<3)health++;
   if(item.type==="shield"){
    invincible=true;
    invincibleTimer=180;
   }
   item.remove=true;
  }
 });
 items=items.filter(i=>!i.remove);

 /* ìŠ¤í…Œì´ì§€ ì§„í–‰ */
 if(score>=10&&!bossMode){
  stage++;
  if(stage>maxStage){
   ending=true;
   gameActive=false;
  }else{
   startStage();
  }
 }
}

/* ---------- ê·¸ë¦¬ê¸° ---------- */
function draw(){
 ctx.clearRect(0,0,baseWidth,baseHeight);

 if(ending){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,baseWidth,baseHeight);
  ctx.fillStyle="white";
  ctx.font="50px Arial";
  ctx.fillText("THE END",400,250);
  ctx.font="30px Arial";
  ctx.fillText("Final Score: "+totalScore,380,300);
  ctx.fillText("Refresh to Play Again",350,350);
  return;
 }

 if(gameOver){
  ctx.fillStyle="rgba(0,0,0,0.7)";
  ctx.fillRect(0,0,baseWidth,baseHeight);
  ctx.fillStyle="white";
  ctx.font="50px Arial";
  ctx.fillText("GAME OVER",380,250);
  ctx.font="25px Arial";
  ctx.fillText("Tap or Press Space to Restart",330,300);
  return;
 }

 ctx.fillStyle="green";
 ctx.fillRect(0,baseHeight-50,baseWidth,50);

 /* í”Œë ˆì´ì–´ ì–¼êµ´ */
 if(invincible){
  ctx.globalAlpha=0.5+Math.sin(Date.now()*0.02)*0.5;
 }
 ctx.fillStyle="#ffcc99";
 ctx.beginPath();
 ctx.arc(player.x+30,player.y+30,30,0,Math.PI*2);
 ctx.fill();

 ctx.fillStyle="black";
 ctx.beginPath();
 ctx.arc(player.x+20,player.y+25,5,0,Math.PI*2);
 ctx.arc(player.x+40,player.y+25,5,0,Math.PI*2);
 ctx.fill();

 ctx.beginPath();
 ctx.arc(player.x+30,player.y+35,10,0,Math.PI);
 ctx.stroke();
 ctx.globalAlpha=1;

 /* ë‚˜ë¬´ ì¥ì• ë¬¼ */
obstacles.forEach(obj=>{
  if(obj.type==="flower"){  // íƒ€ì…ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©

    // ===== ì¤„ê¸° =====
    ctx.fillStyle="#6b3e26";
    ctx.fillRect(obj.x+30, obj.y+60, 20, obj.height-60);

    // ===== ì (í° ì‚¼ê°í˜•) =====
    ctx.fillStyle="#0b6623";
    ctx.beginPath();
    ctx.moveTo(obj.x+40, obj.y);           // ê¼­ëŒ€ê¸°
    ctx.lineTo(obj.x, obj.y+80);           // ì™¼ìª½ ì•„ë˜
    ctx.lineTo(obj.x+80, obj.y+80);        // ì˜¤ë¥¸ìª½ ì•„ë˜
    ctx.closePath();
    ctx.fill();

    // ===== ì¤‘ê°„ ì =====
    ctx.fillStyle="#228B22";
    ctx.beginPath();
    ctx.moveTo(obj.x+40, obj.y+20);
    ctx.lineTo(obj.x+10, obj.y+90);
    ctx.lineTo(obj.x+70, obj.y+90);
    ctx.closePath();
    ctx.fill();

    // ===== ì•„ë˜ ì =====
    ctx.fillStyle="#2e8b57";
    ctx.beginPath();
    ctx.moveTo(obj.x+40, obj.y+40);
    ctx.lineTo(obj.x+20, obj.y+110);
    ctx.lineTo(obj.x+60, obj.y+110);
    ctx.closePath();
    ctx.fill();

  } else{

  let cx = obj.x + obj.width/2;
  let cy = obj.y + obj.height/2;

  // ===== ëª¸í†µ =====
  ctx.fillStyle = "#4b0082";
  ctx.beginPath();
  ctx.ellipse(cx, cy, obj.width/2, obj.height/2, 0, 0, Math.PI*2);
  ctx.fill();

  // ===== ëˆˆ í°ì =====
  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.arc(cx-15, cy-20, 12, 0, Math.PI*2);
  ctx.arc(cx+15, cy-20, 12, 0, Math.PI*2);
  ctx.fill();

  // ===== ëˆˆë™ì =====
  ctx.fillStyle = "black";
  ctx.beginPath();
  ctx.arc(cx-15, cy-20, 6, 0, Math.PI*2);
  ctx.arc(cx+15, cy-20, 6, 0, Math.PI*2);
  ctx.fill();

  // ===== ì… =====
  ctx.fillStyle = "black";
  ctx.beginPath();
  ctx.arc(cx, cy+10, 20, 0, Math.PI);
  ctx.fill();

  // ===== ì´ë¹¨ =====
  ctx.fillStyle = "white";
  for(let i=0;i<5;i++){
    ctx.beginPath();
    ctx.moveTo(cx-20+i*10, cy+10);
    ctx.lineTo(cx-15+i*10, cy+25);
    ctx.lineTo(cx-10+i*10, cy+10);
    ctx.fill();
  }

  // ===== ì™¼ìª½ ë¿” =====
  ctx.fillStyle = "#222";
  ctx.beginPath();
  ctx.moveTo(cx-25, obj.y);
  ctx.lineTo(cx-10, obj.y-30);
  ctx.lineTo(cx-5, obj.y);
  ctx.fill();

  // ===== ì˜¤ë¥¸ìª½ ë¿” =====
  ctx.beginPath();
  ctx.moveTo(cx+25, obj.y);
  ctx.lineTo(cx+10, obj.y-30);
  ctx.lineTo(cx+5, obj.y);
  ctx.fill();
}
});

 /* ì•„ì´í…œ */
 items.forEach(item=>{
  if(item.type==="heart"){
   ctx.fillStyle="red";
   ctx.beginPath();
   ctx.arc(item.x+15,item.y+15,15,0,Math.PI*2);
   ctx.fill();
  }else{
   ctx.fillStyle="gold";
   ctx.beginPath();
   ctx.arc(item.x+15,item.y+15,15,0,Math.PI*2);
   ctx.fill();
  }
 });

 ctx.fillStyle="black";
 ctx.font="20px Arial";
 ctx.fillText("Stage:"+stage,20,30);
 ctx.fillText("HP:"+health,20,60);
}

/* ---------- ë£¨í”„ ---------- */
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
