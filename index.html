<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fantasy Runner Final</title>
<style>
body{margin:0;overflow:hidden;background:#bdeaff;}
canvas{display:block;margin:0 auto;background:#87ceeb;}

.controls{
 position:fixed;
 bottom:15px;
 left:50%;
 transform:translateX(-50%);
 display:flex;
 gap:30px;
}

button{
 width:70px;
 height:70px;
 font-size:24px;
 border-radius:50%;
}

#rotateMessage{
 position:fixed;
 top:0;
 left:0;
 width:100%;
 height:100%;
 background:black;
 color:white;
 display:none;
 justify-content:center;
 align-items:center;
 text-align:center;
 font-size:24px;
 z-index:999;
}
</style>
</head>
<body>

<div id="rotateMessage">üì± Í∞ÄÎ°úÎ°ú ÎèåÎ†§Ï£ºÏÑ∏Ïöî</div>

<canvas id="game"></canvas>

<div class="controls">
<button id="left">‚¨ÖÔ∏è</button>
<button id="jumpBtn">‚¨ÜÔ∏è</button>
<button id="right">‚û°Ô∏è</button>
</div>

<script>
/* ---------- Í≥†Ï†ï Ìï¥ÏÉÅÎèÑ ---------- */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let baseWidth=1000;
let baseHeight=600;
canvas.width=baseWidth;
canvas.height=baseHeight;
canvas.style.width="100vw";
canvas.style.height="100vh";

/* ---------- Î∞©Ìñ• Ï≤¥ÌÅ¨ ---------- */
function checkOrientation(){
 if(window.innerHeight>window.innerWidth){
  rotateMessage.style.display="flex";
 }else{
  rotateMessage.style.display="none";
 }
}
window.addEventListener("resize",checkOrientation);
checkOrientation();

/* ---------- Î≥ÄÏàò ---------- */
let gravity=0.45;
let stage=1;
let score=0;
let totalScore=0;
let spacing=500;
let gameSpeed=3;
let stageObstacleCount=0;
let maxStage=10;

let health=3;
let invincible=false;
let invincibleTimer=0;

let boss=null;
let bossMode=false;
let fireballs=[];

let gameActive=true;
let gameOver=false;
let ending=false;

let keys={left:false,right:false};

let player={
 x:200,
 y:baseHeight-150,
 width:60,
 height:60,
 velocityY:0,
 speed:6,
 jumpCount:0
};

let obstacles=[];
let items=[];

/* ---------- Ï¥àÍ∏∞Ìôî ---------- */
function initGame(){
 stage=1;
 totalScore=0;
 health=3;
 gameOver=false;
 ending=false;
 gameActive=true;
 startStage();
}

function startStage(){
 score=0;
 stageObstacleCount=0;
 obstacles=[];
 items=[];
 bossMode=false;
 boss=null;
 fireballs=[];

 gameSpeed=2+stage;
 spacing=520-stage*25;
 if(spacing<260) spacing=260;

 if(stage===5||stage===10){
  bossMode=true;
  boss={
   x:baseWidth+300,
   y:baseHeight-250,
   width:200,
   height:200,
   health:5,
   velocityY:0,
   jumpCooldown:120,
   dashCooldown:200,
   dashing:false
  };
 }

 player.y=baseHeight-150;
 player.velocityY=0;
 player.jumpCount=0;
}

initGame();

/* ---------- ÏûÖÎ†• ---------- */
function jump(){
 if(gameOver){initGame();return;}
 if(!gameActive)return;

 if(player.jumpCount<3){
  if(player.jumpCount===0) player.velocityY=-18;
  else if(player.jumpCount===1) player.velocityY=-17;
  else player.velocityY=-15;
  player.jumpCount++;
 }
}

document.addEventListener("keydown",e=>{
 if(e.key==="ArrowLeft")keys.left=true;
 if(e.key==="ArrowRight")keys.right=true;
 if(e.key===" "||e.key==="ArrowUp")jump();
});
document.addEventListener("keyup",e=>{
 if(e.key==="ArrowLeft")keys.left=false;
 if(e.key==="ArrowRight")keys.right=false;
});

left.ontouchstart=()=>keys.left=true;
left.ontouchend=()=>keys.left=false;
right.ontouchstart=()=>keys.right=true;
right.ontouchend=()=>keys.right=false;
jumpBtn.ontouchstart=jump;

/* ---------- ÏÉùÏÑ± ---------- */
function spawnObstacle(){
 if(bossMode)return;
 if(stageObstacleCount>=10)return;

 let type=stageObstacleCount<5?"flower":"monster";
 let height=type==="flower"?80:200;
 let lastX=obstacles.length>0?obstacles[obstacles.length-1].x:baseWidth;

 obstacles.push({
  x:lastX+spacing,
  y:baseHeight-50-height,
  width:80,
  height:height,
  type:type,
  passed:false,
  hit:false
 });

 stageObstacleCount++;
}

function spawnItem(){
 if(Math.random()<0.02){
  let type=Math.random()<0.5?"heart":"shield";
  items.push({
   x:baseWidth+100,
   y:Math.random()*(baseHeight-200),
   width:40,
   height:40,
   type:type
  });
 }
}

/* ---------- ÏóÖÎç∞Ïù¥Ìä∏ ---------- */
function update(){
 if(!gameActive)return;

 if(keys.left)player.x-=player.speed;
 if(keys.right)player.x+=player.speed;

 if(player.x<0)player.x=0;
 if(player.x+player.width>baseWidth)
  player.x=baseWidth-player.width;

 player.velocityY+=gravity;
 player.y+=player.velocityY;

 if(player.y+player.height>=baseHeight-50){
  player.y=baseHeight-50-player.height;
  player.jumpCount=0;
 }

 if(invincible){
  invincibleTimer--;
  if(invincibleTimer<=0)invincible=false;
 }

 if(obstacles.length===0||
   obstacles[obstacles.length-1].x<baseWidth-spacing){
  spawnObstacle();
 }

 spawnItem();

 obstacles.forEach(obj=>{
  obj.x-=gameSpeed;

  if(player.x<obj.x+obj.width &&
     player.x+player.width>obj.x &&
     player.y<obj.y+obj.height &&
     player.y+player.height>obj.y){
   if(!obj.hit&&!invincible){
    obj.hit=true;
    health--;
    if(health<=0){gameActive=false;gameOver=true;}
   }
  }

  if(!obj.passed&&obj.x+obj.width<player.x){
   obj.passed=true;
   score++;
   totalScore++;
  }
 });

 items.forEach(item=>{
  item.x-=gameSpeed;

  if(player.x<item.x+item.width &&
     player.x+player.width>item.x &&
     player.y<item.y+item.height &&
     player.y+player.height>item.y){
   if(item.type==="heart"&&health<3)health++;
   if(item.type==="shield"){
    invincible=true;
    invincibleTimer=180;
   }
   item.remove=true;
  }
 });
 items=items.filter(i=>!i.remove);

 /* Ïä§ÌÖåÏù¥ÏßÄ ÏßÑÌñâ */
 if(score>=10&&!bossMode){
  stage++;
  if(stage>maxStage){
   ending=true;
   gameActive=false;
  }else{
   startStage();
  }
 }
}

/* ---------- Í∑∏Î¶¨Í∏∞ ---------- */
function draw(){
 ctx.clearRect(0,0,baseWidth,baseHeight);

 if(ending){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,baseWidth,baseHeight);
  ctx.fillStyle="white";
  ctx.font="50px Arial";
  ctx.fillText("THE END",400,250);
  ctx.font="30px Arial";
  ctx.fillText("Final Score: "+totalScore,380,300);
  ctx.fillText("Refresh to Play Again",350,350);
  return;
 }

 if(gameOver){
  ctx.fillStyle="rgba(0,0,0,0.7)";
  ctx.fillRect(0,0,baseWidth,baseHeight);
  ctx.fillStyle="white";
  ctx.font="50px Arial";
  ctx.fillText("GAME OVER",380,250);
  ctx.font="25px Arial";
  ctx.fillText("Tap or Press Space to Restart",330,300);
  return;
 }

 ctx.fillStyle="green";
 ctx.fillRect(0,baseHeight-50,baseWidth,50);

 /* ÌîåÎ†àÏù¥Ïñ¥ ÏñºÍµ¥ */
 if(invincible){
  ctx.globalAlpha=0.5+Math.sin(Date.now()*0.02)*0.5;
 }
 ctx.fillStyle="#ffcc99";
 ctx.beginPath();
 ctx.arc(player.x+30,player.y+30,30,0,Math.PI*2);
 ctx.fill();

 ctx.fillStyle="black";
 ctx.beginPath();
 ctx.arc(player.x+20,player.y+25,5,0,Math.PI*2);
 ctx.arc(player.x+40,player.y+25,5,0,Math.PI*2);
 ctx.fill();

 ctx.beginPath();
 ctx.arc(player.x+30,player.y+35,10,0,Math.PI);
 ctx.stroke();
 ctx.globalAlpha=1;

 /* ÍΩÉ */
 obstacles.forEach(obj=>{
  if(obj.type==="flower"){
   let cx=obj.x+40;
   let cy=obj.y+40;
   ctx.fillStyle="#ff69b4";
   for(let i=0;i<8;i++){
    let a=Math.PI*2/8*i;
    ctx.beginPath();
    ctx.arc(cx+Math.cos(a)*25,
            cy+Math.sin(a)*25,
            20,0,Math.PI*2);
    ctx.fill();
   }
   ctx.fillStyle="yellow";
   ctx.beginPath();
   ctx.arc(cx,cy,18,0,Math.PI*2);
   ctx.fill();
  }else{
   ctx.fillStyle="purple";
   ctx.fillRect(obj.x,obj.y,obj.width,obj.height);
  }
 });

 /* ÏïÑÏù¥ÌÖú */
 items.forEach(item=>{
  if(item.type==="heart"){
   ctx.fillStyle="red";
   ctx.beginPath();
   ctx.arc(item.x+15,item.y+15,15,0,Math.PI*2);
   ctx.fill();
  }else{
   ctx.fillStyle="gold";
   ctx.beginPath();
   ctx.arc(item.x+15,item.y+15,15,0,Math.PI*2);
   ctx.fill();
  }
 });

 ctx.fillStyle="black";
 ctx.font="20px Arial";
 ctx.fillText("Stage:"+stage,20,30);
 ctx.fillText("HP:"+health,20,60);
}

/* ---------- Î£®ÌîÑ ---------- */
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
